-- AI Predictions and Analytics Schema
-- This schema stores ML predictions and AI agent conversation history

-- Table to store revenue predictions from ML models
CREATE TABLE IF NOT EXISTS predictions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    store_id INT,
    prediction_date DATE NOT NULL,
    predicted_revenue DECIMAL(12, 2) NOT NULL,
    confidence_score DECIMAL(5, 4),
    prediction_type VARCHAR(50) DEFAULT 'daily',  -- 'daily', 'weekly', 'monthly'
    model_name VARCHAR(100) DEFAULT 'prophet',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_store_date (store_id, prediction_date),
    INDEX idx_prediction_date (prediction_date),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table to store detailed forecast components
CREATE TABLE IF NOT EXISTS prediction_components (
    id INT AUTO_INCREMENT PRIMARY KEY,
    prediction_id INT NOT NULL,
    trend DECIMAL(12, 2),
    weekly_seasonality DECIMAL(12, 2),
    yearly_seasonality DECIMAL(12, 2),
    holidays DECIMAL(12, 2),
    yhat_lower DECIMAL(12, 2),  -- Lower bound of prediction
    yhat_upper DECIMAL(12, 2),  -- Upper bound of prediction
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (prediction_id) REFERENCES predictions(id) ON DELETE CASCADE,
    INDEX idx_prediction_id (prediction_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table to store AI Agent conversation history
CREATE TABLE IF NOT EXISTS ai_chat_history (
    id INT AUTO_INCREMENT PRIMARY KEY,
    session_id VARCHAR(100) NOT NULL,
    user_id INT,  -- Optional: link to admin user
    user_message TEXT NOT NULL,
    ai_response TEXT NOT NULL,
    sql_query TEXT,  -- The SQL query generated by AI
    query_results JSON,  -- Store query results
    execution_time_ms INT,  -- Time taken to execute query
    is_successful BOOLEAN DEFAULT TRUE,
    error_message TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_session_id (session_id),
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Table to store common insights and recommendations
CREATE TABLE IF NOT EXISTS ai_insights (
    id INT AUTO_INCREMENT PRIMARY KEY,
    insight_type VARCHAR(50) NOT NULL,  -- 'revenue_alert', 'trend_change', 'recommendation', etc.
    store_id INT,
    title VARCHAR(255) NOT NULL,
    description TEXT NOT NULL,
    severity VARCHAR(20) DEFAULT 'info',  -- 'info', 'warning', 'critical'
    related_prediction_id INT,
    metadata JSON,  -- Additional data like thresholds, percentages, etc.
    is_read BOOLEAN DEFAULT FALSE,
    is_dismissed BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    expires_at TIMESTAMP,

    FOREIGN KEY (related_prediction_id) REFERENCES predictions(id) ON DELETE SET NULL,
    INDEX idx_store_id (store_id),
    INDEX idx_insight_type (insight_type),
    INDEX idx_created_at (created_at),
    INDEX idx_is_read (is_read)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

-- Sample data for testing (optional)
-- INSERT INTO predictions (store_id, prediction_date, predicted_revenue, confidence_score, model_name)
-- VALUES
--     (1, '2025-01-20', 15000000.00, 0.8523, 'prophet'),
--     (1, '2025-01-21', 18500000.00, 0.8234, 'prophet'),
--     (2, '2025-01-20', 12000000.00, 0.7934, 'prophet');
